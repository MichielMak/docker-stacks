{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":enableVulnerabilityAlerts"
  ],
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dependency Dashboard Michiel",
  "dependencyDashboardHeader": "This issue contains a list of Renovate updates and statuses.",
  "timezone": "Europe/Amsterdam",
  "assigneesFromCodeOwners": true,
  "enabledManagers": [
    "docker-compose"
  ],
  "labels": [
    "renovate"
  ],
  "ignoreUnstable": true,
  "prHourlyLimit": 6,
  "prConcurrentLimit": 10,
  "pinDigests": true,
  "automerge": true,
  "automergeType": "pr",
  "platformAutomerge": true,
  "pruneStaleBranches": true,
  "dependencyDashboardAutoclose": false,
  "rebaseWhen": "behind-base-branch",
  "branchConcurrentLimit": 10,
  "gitIgnoredAuthors": [
    "self-hosted-renovate-mm"
  ],
  "packageRules": [
    {
      "description": "Docker: allow only stable SemVer or CalVer",
      "matchDatasources": [
        "docker"
      ],
      "allowedVersions": "/^(?:\\d+\\.\\d+\\.\\d+(?:[-._][A-Za-z0-9]+)?|20\\d{2}\\.\\d{1,2}(?:\\.\\d+)?)$/i"
    },
    {
      "description": "Docker: reject prereleases globally",
      "matchDatasources": [
        "docker"
      ],
      "allowedVersions": "!/(alpha|beta|rc|canary|nightly|snapshot|preview|experimental|dev)/i"
    },
    {
      "description": "Docker: reject hash-only and channel tags",
      "matchDatasources": [
        "docker"
      ],
      "allowedVersions": "!/^(?:latest|stable|edge|release|rolling|master|main)$|^[a-f0-9]{7,}$/i"
    },
    {
      "description": "Hotio: parse release-/pr-plugins- <semver> tags",
      "matchPackageNames": [
        "/^ghcr\\.io\\/hotio\\//"
      ],
      "versioning": "regex:^(?:release-|pr-plugins-)?(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)(?:\\.(?<build>\\d+))?$"
    },
    {
      "description": "Lidarr: only use pr-plugins branch",
      "matchPackageNames": [
        "ghcr.io/hotio/lidarr"
      ],
      "allowedVersions": "/^pr-plugins-/"
    },
    {
      "description": "Postgres: only track 16.x (including distro suffixes)",
      "matchPackageNames": [
        "/^docker\\.io\\/library\\/postgres$/"
      ],
      "allowedVersions": "/^16(?:\\.\\d+){0,2}(?:-[A-Za-z0-9.-]+)?$/"
    },
    {
      "description": "Immich Infrastructure: Ignore Redis/Valkey and PostgreSQL updates",
      "matchFileNames": [
        "**/immich-app/compose.yaml",
        "**/immich-app/compose.yml",
        "**/immich-app/docker-compose.yaml",
        "**/immich-app/docker-compose.yml"
      ],
      "matchPackageNames": [
        "/^docker\\.io\\/valkey\\//",
        "/^docker\\.io\\/redis\\//",
        "/^ghcr\\.io\\/immich-app\\/postgres/"
      ],
      "enabled": false
    },
    {
      "description": "Immich Apps: Group only immich-server and immich-machine-learning together",
      "matchFileNames": [
        "**/immich-app/compose.yaml",
        "**/immich-app/compose.yml",
        "**/immich-app/docker-compose.yaml",
        "**/immich-app/docker-compose.yml"
      ],
      "matchPackageNames": [
        "/^ghcr\\.io\\/immich-app\\/immich-server/",
        "/^ghcr\\.io\\/immich-app\\/immich-machine-learning/"
      ],
      "groupName": "immich-apps",
      "groupSlug": "immich-apps",
      "addLabels": [
        "immich-apps"
      ]
    },
    {
      "description": "Group updates strictly per compose file directory",
      "matchManagers": [
        "docker-compose"
      ],
      "matchFileNames": [
        "**/compose.yaml",
        "**/compose.yml",
        "**/docker-compose.yaml",
        "**/docker-compose.yml"
      ],
      "groupName": "stack: {{parentDir}}",
      "groupSlug": "stack-{{parentDir}}",
      "addLabels": [
        "stack:{{parentDir}}"
      ],
      "matchPackageNames": [
        "!/^docker\\.io\\/valkey\\//",
        "!/^docker\\.io\\/redis\\//",
        "!/^ghcr\\.io\\/immich-app\\/postgres/",
        "!/^ghcr\\.io\\/immich-app\\/immich-server/",
        "!/^ghcr\\.io\\/immich-app\\/immich-machine-learning/"
      ]
    },
    {
      "description": "Minimum release age for Docker to avoid fresh-tag churn",
      "matchDatasources": [
        "docker"
      ],
      "minimumReleaseAge": "12 hours"
    },
    {
      "description": "Open PRs immediately for digest/minor/patch; majors stay separate",
      "matchDatasources": [
        "docker"
      ],
      "separateMajorMinor": true
    },
    {
      "description": "Swap floating docker tags to numbered tags (SemVer or CalVer) when available",
      "matchDatasources": [
        "docker"
      ],
      "matchCurrentVersion": "/^(latest|stable|release|edge)$/i",
      "rangeStrategy": "replace",
      "allowedVersions": "/^(?:\\d+(?:\\.\\d+){1,2}(?:[-._][A-Za-z0-9]+)?)|(20\\d{2}\\.\\d{1,2}(?:\\.\\d+)?)$/",
      "versioning": "loose"
    },
    {
      "description": "Don't resurrect closed digest PRs",
      "matchManagers": [
        "docker-compose"
      ],
      "matchUpdateTypes": [
        "digest"
      ],
      "recreateWhen": "never"
    }
  ],
  "hostRules": [
    {
      "matchHost": "ghcr.io",
      "hostType": "docker",
      "concurrentRequestLimit": 2,
      "timeout": 120000
    },
    {
      "matchHost": "lscr.io",
      "hostType": "docker",
      "concurrentRequestLimit": 2,
      "timeout": 120000
    },
    {
      "matchHost": "registry-1.docker.io",
      "hostType": "docker",
      "concurrentRequestLimit": 2,
      "timeout": 120000
    }
  ]
}
