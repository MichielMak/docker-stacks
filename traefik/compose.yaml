networks:
  npm:
    external: true

services:
  traefik:
    image: traefik:v3.5.3@sha256:d6be8725d21b45bdd84b93ea01438256e0e3c94aa8fa51834fe87f37cd5d4af8
    container_name: traefik
    restart: unless-stopped
    networks:
      - npm
    ports:
      - 80:80
      - 443:443
    environment:
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN}   # Cloudflare token (DNS:Edit + Zone:Read)
    command:
      # Providers
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443

      # Let's Encrypt (ACME) via DNS-01 (wildcard)
      - --certificatesresolvers.letsencrypt.acme.email=${LE_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare

      # Gebruik één wildcard cert voor ${DOMAIN} en *.${DOMAIN}
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN}

      # Dashboard
      - --api.dashboard=true
      - --api.insecure=false

      # Logging
      - --log.level=INFO
      - --accesslog=true
      - --accesslog.fields.defaultmode=keep
      - --accesslog.fields.names.ClientUsername=drop

      # Security / performance
#      - --experimental.http3=true
      - --serversTransport.insecureSkipVerify=false
    labels:
      traefik.enable: "true"

      # Dashboard router
      traefik.http.routers.traefik.rule: Host(`${TRAEFIK_HOST}`)
      traefik.http.routers.traefik.entrypoints: websecure
      traefik.http.routers.traefik.service: api@internal

      # Security headers (herbruikbare middleware)
      traefik.http.middlewares.sec-headers.headers.stsSeconds: 31536000
      traefik.http.middlewares.sec-headers.headers.stsIncludeSubdomains: "true"
      traefik.http.middlewares.sec-headers.headers.stsPreload: "true"
      traefik.http.middlewares.sec-headers.headers.customFrameOptionsValue: SAMEORIGIN
      traefik.http.middlewares.sec-headers.headers.contentTypeNosniff: "true"
      traefik.http.middlewares.sec-headers.headers.referrerPolicy: no-referrer-when-downgrade
      traefik.http.middlewares.sec-headers.headers.permissionsPolicy: geolocation=(), microphone=(), camera=()

            # Router (HTTPS)
      traefik.http.routers.ha.rule=Host(`hass.${DOMAIN}`)
      traefik.http.routers.ha.entrypoints=websecure
      traefik.http.routers.ha.tls=true
      traefik.http.routers.ha.tls.certresolver=letsencrypt

      # Service -> HTTP backend on the NUC
      traefik.http.services.ha.loadbalancer.server.scheme=http
      traefik.http.services.ha.loadbalancer.server.port=8123
      traefik.http.services.ha.loadbalancer.servers.0.url=http://${HASS_IP}:8123
      # Optional: if you later enable HTTPS on HA itself, flip scheme to https and (if self-signed) add a serversTransport with insecureSkipVerify=true

      # Middlewares (pick/adjust)
      # Security headers
      traefik.http.middlewares.ha-sec.headers.stsSeconds=31536000
      traefik.http.middlewares.ha-sec.headers.stsIncludeSubdomains=true
      traefik.http.middlewares.ha-sec.headers.stsPreload=true
      traefik.http.middlewares.ha-sec.headers.contentTypeNosniff=true
      traefik.http.middlewares.ha-sec.headers.referrerPolicy=no-referrer
      traefik.http.middlewares.ha-sec.headers.customRequestHeaders.X-Forwarded-Proto=https

      # Attach chosen middlewares
      traefik.http.routers.ha.middlewares=ha-sec
      # or, if using SSO:
      # - traefik.http.routers.ha.middlewares=ha-auth,ha-sec,ha-rl

      # Optioneel: BasicAuth of ForwardAuth (Authentik)
      # traefik.http.middlewares.dash-auth.basicauth.users: ${TRAEFIK_DASH_USERS}
      # traefik.http.routers.traefik.middlewares: dash-auth,sec-headers@docker
      # traefik.http.middlewares.authentik.forwardauth.address: https://auth.${DOMAIN}/outpost.goauthentik.io/auth/traefik
      # traefik.http.middlewares.authentik.forwardauth.trustForwardHeader: "true"
      # traefik.http.middlewares.authentik.forwardauth.authResponseHeaders: X-authentik-username,X-authentik-groups

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${DOCKER_DATA_DIR}/traefik/letsencrypt:/letsencrypt