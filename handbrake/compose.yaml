services:
  handbrake:
    tty: true
    container_name: handbrake
    devices:
      - /dev/dri/:/dev/dri/
    #    ports:
    #      - 5800:5800
    volumes:
      - ${DOCKER_DATA_DIR}/handbrake/config:/config:rw
      - ${OVERIG_DIR}:/storage:ro
      - ${MEDIA_DIR}:/mnt/media:ro
      - ${OVERIG_DIR}/prestage:/output:rw
    environment:
      - USER_ID=${PUID}
      - GROUP_ID=${PGID}
      - HANDBRAKE_GUI=1
      - TZ=Europe/Amsterdam
      - DARK_MODE=1
    image: jlesage/handbrake:v25.12.1@sha256:9320394139150370940fabd41a9aaba2e55bbfa17468463c795f6a765369986e
    restart: unless-stopped
    networks:
      - npm
    labels:
      - traefik.enable=true
      - traefik.http.routers.handbrake.middlewares=authentik-forwardauth@docker
      - traefik.http.routers.handbrake.rule=Host(`handbrake.${DOMAIN}`)
      - traefik.http.routers.handbrake.entrypoints=websecure
      - traefik.http.routers.handbrake.tls=true
      - traefik.http.services.handbrake.loadbalancer.server.port=5800
networks:
  npm:
    external: true
