services:
  booklore:
    image: booklore/booklore:v1.11.0@sha256:bdfcb7cb9ee85010c41ca2a9dba462a15c811c04cd6d54707baf12483e2e7396
    container_name: booklore
    environment:
      - USER_ID=${PUID}
      - GROUP_ID=${PGID}
      - TZ=Europe/Amsterdam
      - DATABASE_URL=jdbc:mariadb://bookloremariadb:3306/booklore
      - DATABASE_USERNAME=booklore
      - DATABASE_PASSWORD=${MYSQL_PASSWORD}
      - REMOTE_AUTH_ENABLED=true
      - REMOTE_AUTH_CREATE_NEW_USERS=true
      - REMOTE_AUTH_HEADER_NAME=Remote-Name
      - REMOTE_AUTH_HEADER_USER=Remote-User
      - REMOTE_AUTH_HEADER_EMAIL=Remote-Email
      - REMOTE_AUTH_HEADER_GROUPS=Remote-Groups
      - REMOTE_AUTH_ADMIN_GROUP=admin
    depends_on:
      bookloremariadb:
        condition: service_healthy
    volumes:
      - ${DOCKER_DATA_DIR}/booklore/config:/app/data
      - ${MEDIA_DIR}/books:/books
      - ${MEDIA_DIR}/downloads/usenet/books:/bookdrop
    restart: unless-stopped
    networks:
      - npm
    labels:
      - homepage.group=Media
      - homepage.name=BookLore
      - homepage.icon=sh-booklore.png
      - homepage.href=http://booklore.${DOMAIN}/
      - homepage.description=Personal digital library for ebooks and audiobooks
      # Main router for booklore.${DOMAIN}
      - traefik.enable=true
      - traefik.docker.network=npm
      - traefik.http.routers.booklore.rule=Host(`booklore.${DOMAIN}`)
      - traefik.http.routers.booklore.entrypoints=websecure
      - traefik.http.routers.booklore.tls=true
      - traefik.http.services.booklore.loadbalancer.server.port=6060
      # Test router for books.${DOMAIN} with guest auto-login
      - traefik.http.routers.booklore-test.rule=Host(`books.${DOMAIN}`)
      - traefik.http.routers.booklore-test.entrypoints=websecure
      - traefik.http.routers.booklore-test.tls=true
      - traefik.http.routers.booklore-test.service=booklore
      - traefik.http.routers.booklore-test.middlewares=booklore-guest-auth
      # Guest auth middleware using headers
      - traefik.http.middlewares.booklore-guest-auth.headers.customrequestheaders.Remote-User=guest
      - traefik.http.middlewares.booklore-guest-auth.headers.customrequestheaders.Remote-Name=Guest User
      - traefik.http.middlewares.booklore-guest-auth.headers.customrequestheaders.Remote-Email=guest@${DOMAIN}
      - traefik.http.middlewares.booklore-guest-auth.headers.customrequestheaders.Remote-Groups=
  bookloremariadb:
    image: linuxserver/mariadb:11.4.8@sha256:73a403f999eb7317b0fcd084f42bd77ed813f4e09d2a4ebc1ba90ea48e43041a
    container_name: bookloremariadb
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=Europe/Amsterdam
      - MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
      - MYSQL_DATABASE=booklore
      - MYSQL_USER=booklore
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - ${DOCKER_DATA_DIR}/bookloremariadb/config:/config
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - mariadb-admin
        - ping
        - -h
        - localhost
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - npm
networks:
  npm:
    external: true